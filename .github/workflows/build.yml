name: Build Slim PyArrow

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      arrow_version:
        description: 'Arrow version to build'
        required: false
        default: '18.1.0'

env:
  ARROW_VERSION: ${{ github.event.inputs.arrow_version || '18.1.0' }}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux AMD64
          - arch: amd64
            python: '3.10'
            manylinux: manylinux2014_x86_64
            platform_tag: x86_64
          - arch: amd64
            python: '3.11'
            manylinux: manylinux2014_x86_64
            platform_tag: x86_64
          - arch: amd64
            python: '3.12'
            manylinux: manylinux2014_x86_64
            platform_tag: x86_64
          # Linux ARM64 (using QEMU emulation)
          - arch: arm64
            python: '3.10'
            manylinux: manylinux2014_aarch64
            platform_tag: aarch64
          - arch: arm64
            python: '3.11'
            manylinux: manylinux2014_aarch64
            platform_tag: aarch64
          - arch: arm64
            python: '3.12'
            manylinux: manylinux2014_aarch64
            platform_tag: aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (for ARM64 builds)
        if: matrix.arch == 'arm64'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get Python version tag
        id: python
        run: |
          PYTHON_TAG="cp$(echo ${{ matrix.python }} | tr -d '.')"
          echo "tag=${PYTHON_TAG}-${PYTHON_TAG}" >> $GITHUB_OUTPUT
          echo "Python tag: ${PYTHON_TAG}"

      - name: Create wheelhouse directory
        run: mkdir -p wheelhouse

      - name: Build PyArrow wheel
        run: |
          docker run --rm \
            --platform linux/${{ matrix.arch }} \
            -v ${{ github.workspace }}/wheelhouse:/wheelhouse \
            -e ARROW_VERSION=${{ env.ARROW_VERSION }} \
            -e PYTHON_TAG=${{ steps.python.outputs.tag }} \
            quay.io/pypa/${{ matrix.manylinux }} \
            /bin/bash -c '
              set -ex
              
              # Install build tools
              yum install -y cmake3 ninja-build git wget
              ln -sf /usr/bin/cmake3 /usr/bin/cmake
              
              # Set paths
              export ARROW_HOME=/opt/arrow
              export PATH="${ARROW_HOME}/bin:${PATH}"
              export LD_LIBRARY_PATH="${ARROW_HOME}/lib:${ARROW_HOME}/lib64"
              
              # Fix CMake compatibility with bundled dependencies
              export CMAKE_POLICY_VERSION_MINIMUM=3.5
              
              # Clone Arrow
              cd /tmp
              git clone --depth 1 --branch apache-arrow-${ARROW_VERSION} \
                https://github.com/apache/arrow.git
              
              # Build Arrow C++
              mkdir -p /tmp/arrow/cpp/build
              cd /tmp/arrow/cpp/build
              cmake .. \
                -GNinja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=${ARROW_HOME} \
                -DCMAKE_INSTALL_LIBDIR=lib \
                -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
                -DARROW_PARQUET=ON \
                -DARROW_FILESYSTEM=ON \
                -DARROW_COMPUTE=ON \
                -DARROW_IPC=ON \
                -DARROW_DATASET=ON \
                -DARROW_WITH_SNAPPY=ON \
                -DARROW_WITH_ZSTD=ON \
                -DARROW_WITH_LZ4=ON \
                -DARROW_WITH_ZLIB=ON \
                -DARROW_S3=OFF \
                -DARROW_GCS=OFF \
                -DARROW_AZURE=OFF \
                -DARROW_HDFS=OFF \
                -DARROW_FLIGHT=OFF \
                -DARROW_FLIGHT_SQL=OFF \
                -DARROW_GANDIVA=OFF \
                -DARROW_ORC=OFF \
                -DARROW_CUDA=OFF \
                -DARROW_SUBSTRAIT=OFF \
                -DARROW_CSV=OFF \
                -DARROW_JSON=OFF \
                -DARROW_ACERO=OFF \
                -DARROW_BUILD_TESTS=OFF \
                -DARROW_BUILD_BENCHMARKS=OFF \
                -DARROW_BUILD_UTILITIES=OFF \
                -DARROW_DEPENDENCY_SOURCE=BUNDLED
              ninja install
              
              # Build PyArrow
              PYTHON_BIN=/opt/python/${PYTHON_TAG}/bin/python
              ${PYTHON_BIN} -m pip install cython numpy setuptools wheel setuptools_scm
              
              cd /tmp/arrow/python
              export PYARROW_WITH_PARQUET=1
              export PYARROW_WITH_DATASET=1
              export PYARROW_WITH_S3=0
              export PYARROW_WITH_GCS=0
              export PYARROW_WITH_HDFS=0
              export PYARROW_WITH_FLIGHT=0
              export PYARROW_WITH_GANDIVA=0
              export PYARROW_WITH_ORC=0
              export PYARROW_WITH_CUDA=0
              export PYARROW_WITH_SUBSTRAIT=0
              export PYARROW_WITH_ACERO=0
              export PYARROW_BUNDLE_ARROW_CPP=1
              
              ${PYTHON_BIN} setup.py build_ext --build-type=release bdist_wheel
              
              # Repair wheel
              auditwheel repair dist/*.whl -w /wheelhouse
            '

      - name: List built wheels
        run: ls -lh wheelhouse/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: pyarrow-slim-${{ matrix.arch }}-py${{ matrix.python }}
          path: wheelhouse/*.whl
          retention-days: 30

  # Combine all wheels into a single artifact
  combine-wheels:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pyarrow-slim-*
          path: all-wheels
          merge-multiple: true

      - name: List all wheels
        run: |
          echo "=== All built wheels ==="
          ls -lh all-wheels/
          echo ""
          echo "=== Total size ==="
          du -sh all-wheels/

      - name: Upload combined artifact
        uses: actions/upload-artifact@v4
        with:
          name: pyarrow-slim-all-wheels
          path: all-wheels/*.whl
          retention-days: 90

  # Create GitHub Release with wheels
  release:
    needs: combine-wheels
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          name: pyarrow-slim-all-wheels
          path: wheels

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: wheels/*.whl
          generate_release_notes: true
          body: |
            ## Slim PyArrow Wheels for PyIceberg
            
            These wheels contain a minimal PyArrow build optimized for PyIceberg with Cloudflare R2 Data Catalog.
            
            ### Enabled Features
            - Parquet file support
            - Filesystem abstraction
            - Compute kernels
            - Dataset API
            - Compression: Snappy, ZSTD, LZ4, ZLIB
            
            ### Disabled Features (for smaller size)
            - S3/GCS/Azure native filesystem (use `s3fs` instead)
            - HDFS, Flight, Gandiva, ORC, CUDA, Substrait, Acero
            
            ### Installation
            ```bash
            pip install pyarrow --no-index --find-links https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/
            ```
            
            Or install a specific wheel:
            ```bash
            pip install https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/pyarrow-18.1.0-cp311-cp311-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
            ```

  # Test the built wheels
  test:
    needs: combine-wheels
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            platform_tag: x86_64
          # ARM64 test would require QEMU which is slow, skip for now
          # - arch: arm64
          #   platform_tag: aarch64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          name: pyarrow-slim-all-wheels
          path: wheels

      - name: List available wheels
        run: ls -la wheels/

      - name: Install slim PyArrow
        run: |
          # Find the correct wheel for this platform
          WHEEL=$(ls wheels/*cp311*${{ matrix.platform_tag }}*.whl | head -1)
          echo "Installing: ${WHEEL}"
          pip install "${WHEEL}"

      - name: Test PyArrow imports
        run: |
          python -c "
          import pyarrow
          print(f'PyArrow version: {pyarrow.__version__}')
          
          import pyarrow.parquet as pq
          print('✓ pyarrow.parquet imported')
          
          import pyarrow.compute as pc
          print('✓ pyarrow.compute imported')
          
          import pyarrow.dataset as ds
          print('✓ pyarrow.dataset imported')
          
          import pyarrow.fs as pafs
          print('✓ pyarrow.fs imported')
          
          # Verify S3 is NOT available (as expected)
          try:
              from pyarrow.fs import S3FileSystem
              print('⚠ S3FileSystem available (unexpected)')
          except ImportError:
              print('✓ S3FileSystem not available (expected - use s3fs)')
          
          print('')
          print('All imports successful!')
          "

      - name: Test PyIceberg compatibility
        run: |
          pip install "pyiceberg[s3fs]"
          python -c "
          import pyarrow
          import pyarrow.parquet
          from pyiceberg.catalog import load_catalog
          print('✓ PyIceberg with PyArrow imported successfully')
          "

      - name: Test wheel size
        run: |
          WHEEL=$(ls wheels/*cp311*${{ matrix.platform_tag }}*.whl | head -1)
          SIZE=$(stat -c%s "${WHEEL}")
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Wheel size: ${SIZE_MB} MB"
          if [ ${SIZE_MB} -gt 100 ]; then
            echo "⚠ Warning: Wheel is larger than 100MB target"
          else
            echo "✓ Wheel size is acceptable"
          fi
